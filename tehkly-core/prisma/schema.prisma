generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  name              String?
  phoneNumber       String             @unique
  birthDate         String
  role              UserRole           @default(USER)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  userSubscriptions UserSubscription[]
  payments          Payment[]
  couponUsages      CouponUsage[]
  cloudUsage        UserCloudUsage[]
  agendeUsage       UserAgendeUsage[]
}

// ===== PLANOS - Criados por admins =====

model SubscriptionPlan {
  id String @id @default(cuid())

  service     Service
  name        String // Ex: "Cloud Básico", "Agende Pro"
  description String?

  // Valores base
  monthlyPrice Decimal @db.Decimal(10, 2)

  // Descontos por período
  quarterlyDiscount Int @default(0) // % desconto trimestral
  annualDiscount    Int @default(0) // % desconto anual

  // Trial
  trialDays Int @default(0) // Dias de trial gratuito

  isActive  Boolean   @default(true)
  isPublic  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Features específicas por serviço
  cloudFeatures    CloudFeatures?
  agendeFeatures   AgendeFeatures?
  freelaFeatures   FreelaFeatures?
  businessFeatures BusinessFeatures?

  userSubscriptions UserSubscription[]

  @@unique([service, name])
  @@index([service, isActive])
  @@index([isActive, deletedAt])
}

// ===== FEATURES POR SERVIÇO =====

model CloudFeatures {
  id     String           @id @default(cuid())
  planId String           @unique
  plan   SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  // Storage
  storageGB          Int
  maxUsers           Int     @default(1)
  maxFileSize        Int // MB
  maxBandwidthGB     Int     @default(0) // 0 = ilimitado
  allowPublicSharing Boolean @default(false)
  allowCustomDomain  Boolean @default(false)
  supportLevel       String  @default("BASIC") // BASIC, PRIORITY, PREMIUM

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AgendeFeatures {
  id     String           @id @default(cuid())
  planId String           @unique
  plan   SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  // Limites
  maxAppointmentsPerMonth  Int
  maxOrganizations         Int
  maxPointsPerOrganization Int
  allowCustomBranding      Boolean @default(false)
  allowWhitelabel          Boolean @default(false)
  supportLevel             String  @default("BASIC")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FreelaFeatures {
  id     String           @id @default(cuid())
  planId String           @unique
  plan   SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  maxProjects       Int
  maxClients        Int
  allowInvoicing    Boolean @default(false)
  allowTimeTracking Boolean @default(true)
  supportLevel      String  @default("BASIC")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BusinessFeatures {
  id     String           @id @default(cuid())
  planId String           @unique
  plan   SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  supportLevel String @default("BASIC")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===== RASTREAMENTO DE USO =====

model UserCloudUsage {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  usedStorageGB   Decimal @db.Decimal(10, 2)
  usedBandwidthGB Decimal @db.Decimal(10, 2)
  fileCount       Int

  // Resetar mensalmente
  periodStart DateTime
  periodEnd   DateTime

  updatedAt DateTime @updatedAt

  @@unique([userId, periodStart])
  @@index([userId])
}

model UserAgendeUsage {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  appointmentsCount  Int
  organizationsCount Int

  // Resetar mensalmente
  periodStart DateTime
  periodEnd   DateTime

  updatedAt DateTime @updatedAt

  @@unique([userId, periodStart])
  @@index([userId])
}

// ===== CUPONS E DESCONTOS =====

model Coupon {
  id          String  @id @default(cuid())
  code        String  @unique
  description String?

  discountType  CouponType
  discountValue Decimal    @db.Decimal(10, 2)

  // Restrições
  service        Service? // null = válido para todos
  minPurchase    Decimal? @db.Decimal(10, 2)
  maxDiscount    Decimal? @db.Decimal(10, 2)
  maxUses        Int?
  maxUsesPerUser Int      @default(1)

  validFrom  DateTime
  validUntil DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usages            CouponUsage[]
  userSubscriptions UserSubscription[]

  @@index([code, isActive])
  @@index([validFrom, validUntil])
}

model CouponUsage {
  id                 String @id @default(cuid())
  couponId           String
  coupon             Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  userId             String
  user               User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userSubscriptionId String

  discountApplied Decimal  @db.Decimal(10, 2)
  usedAt          DateTime @default(now())

  @@index([couponId])
  @@index([userId])
}

// ===== ASSINATURAS DOS USUÁRIOS =====

model UserSubscription {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  planId String
  plan   SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)

  // Tipo de plano contratado
  planType PlanType

  // Valores no momento da contratação (congelados)
  monthlyPrice    Decimal @db.Decimal(10, 2)
  discountPercent Int     @default(0)
  totalAmount     Decimal @db.Decimal(10, 2)

  // Período
  startDate DateTime
  endDate   DateTime

  // Trial
  trialEndsAt DateTime?
  isTrialUsed Boolean   @default(false)

  // Status
  status    SubscriptionStatus @default(PENDING)
  autoRenew Boolean            @default(true)

  // Datas importantes
  lastRenewalDate DateTime?
  nextBillingDate DateTime?

  // Cancelamento
  cancelledAt             DateTime?
  cancelReason            String?
  cancellationRequestedBy String? // userId

  // Para upgrade/downgrade
  pendingPlanId        String?
  pendingPlanStartDate DateTime?

  // Cupom aplicado
  couponId String?
  coupon   Coupon? @relation(fields: [couponId], references: [id], onDelete: SetNull)

  // Mercado Pago
  mpPreferenceId   String?
  mpSubscriptionId String?

  payments      Payment[]
  history       SubscriptionHistory[]
  notifications SubscriptionNotification[]
  renewalConfig RenewalConfiguration?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([planId])
  @@index([endDate])
  @@index([status, endDate])
  @@index([userId, status, planId])
  @@index([nextBillingDate])
}

// ===== HISTÓRICO DE MUDANÇAS =====

model SubscriptionHistory {
  id             String           @id @default(cuid())
  subscriptionId String
  subscription   UserSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  previousStatus SubscriptionStatus
  newStatus      SubscriptionStatus
  reason         String?
  changedBy      String? // userId de quem fez a mudança

  metadata Json? // Dados adicionais sobre a mudança

  createdAt DateTime @default(now())

  @@index([subscriptionId])
  @@index([subscriptionId, createdAt])
}

// ===== CONFIGURAÇÃO DE RENOVAÇÃO =====

model RenewalConfiguration {
  id             String           @id @default(cuid())
  subscriptionId String           @unique
  subscription   UserSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  maxRetries        Int     @default(3)
  retryIntervalDays Int     @default(3)
  sendReminderEmail Boolean @default(true)
  gracePeriodDays   Int     @default(7)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===== NOTIFICAÇÕES =====

model SubscriptionNotification {
  id             String           @id @default(cuid())
  subscriptionId String
  subscription   UserSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  type      NotificationType
  sentAt    DateTime?
  scheduled DateTime

  // Para retry em caso de falha
  attempts  Int     @default(0)
  lastError String?

  createdAt DateTime @default(now())

  @@index([subscriptionId, scheduled])
  @@index([scheduled, sentAt])
}

// ===== PAGAMENTOS =====

model Payment {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  userSubscriptionId String
  userSubscription   UserSubscription @relation(fields: [userSubscriptionId], references: [id], onDelete: Cascade)

  // Valores
  amount         Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  finalAmount    Decimal @db.Decimal(10, 2)
  currency       String  @default("BRL")

  // Parcelamento
  installments Int @default(1)

  // Período cobrado
  billingPeriodStart DateTime?
  billingPeriodEnd   DateTime?

  // Mercado Pago
  paymentMethod  MercadoPagoPaymentMethod
  mpPaymentId    String?                  @unique
  mpStatus       String?
  mpStatusDetail String?

  // Status
  status PaymentStatus @default(PENDING)
  paidAt DateTime?

  // Tentativas
  attemptNumber Int @default(1)

  // Fatura/Nota Fiscal
  invoiceUrl    String?
  invoiceNumber String?

  // Webhook e metadados
  metadata     Json?
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userSubscriptionId])
  @@index([status])
  @@index([mpPaymentId])
  @@index([status, createdAt])
  @@index([paidAt])
}

// ===== ENUMS =====

enum UserRole {
  ROOT
  SUPER_ADMIN
  ADMIN
  USER
}

enum Service {
  CLOUD
  AGENDE
  FREELA
  BUSINESS
}

enum PlanType {
  MONTHLY
  QUARTERLY
  ANNUAL
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  APPROVED
  IN_PROCESS
  REJECTED
  CANCELLED
  REFUNDED
}

enum MercadoPagoPaymentMethod {
  CREDIT_CARD
  ACCOUNT_MONEY
  PIX
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum NotificationType {
  PAYMENT_REMINDER // 3 dias antes
  PAYMENT_DUE // no dia
  PAYMENT_OVERDUE // após vencimento
  RENEWAL_REMINDER // 7 dias antes
  TRIAL_ENDING // 2 dias antes do trial acabar
  SUBSCRIPTION_CANCELLED
  SUBSCRIPTION_ACTIVATED
  PAYMENT_FAILED
}
